set search_path = public;\n\ncreate table if not exists residents (\n  unit_id text primary key,\n  owner_name text\n);\n\ncreate table if not exists votes (\n  id uuid default gen_random_uuid() primary key,\n  unit_id text not null,\n  poll_id text not null default 'painting-2025',\n  token text,\n  \"option\" text,\n  created_at timestamptz default now()\n);\n\ncreate unique index if not exists votes_unique_per_poll_unit on votes (poll_id, unit_id);\ncreate unique index if not exists votes_unique_token on votes (token) where token is not null;\n\ncreate table if not exists vote_audit (\n  id bigserial primary key,\n  action text not null,\n  voter_name text,\n  unit_id text,\n  ip text,\n  user_agent text,\n  details jsonb,\n  created_at timestamptz default now()\n);\n\ncreate table if not exists admin_settings (\n  id boolean primary key default true,\n  username text not null,\n  password_hash text not null,\n  option_a_url text,\n  option_b_url text,\n  option_c_url text,\n  created_at timestamptz default now(),\n  updated_at timestamptz default now()\n);\n\ncreate table if not exists qr_tokens (\n  token text primary key,\n  unit_id text not null,\n  expires_at timestamptz not null,\n  used_at timestamptz,\n  used_by_unit text,\n  created_at timestamptz default now()\n);\n\nalter table residents enable row level security;\nalter table votes enable row level security;\nalter table vote_audit enable row level security;\nalter table admin_settings enable row level security;\nalter table qr_tokens enable row level security;\n\ndrop policy if exists allow_all_residents on residents;\ncreate policy allow_all_residents on residents for all using (true) with check (true);\ndrop policy if exists allow_all_votes on votes;\ncreate policy allow_all_votes on votes for all using (true) with check (true);\ndrop policy if exists allow_all_audit on vote_audit;\ncreate policy allow_all_audit on vote_audit for all using (true) with check (true);\ndrop policy if exists allow_all_admin on admin_settings;\ncreate policy allow_all_admin on admin_settings for all using (true) with check (true);\ndrop policy if exists allow_all_qr on qr_tokens;\ncreate policy allow_all_qr on qr_tokens for all using (true) with check (true);\n\ndrop constraint if exists votes_option_chk;\nalter table votes add constraint votes_option_chk check (\"option\" in ('A','B','C'));\n\nNOTIFY pgrst, 'reload schema';\n